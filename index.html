<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="description" content="Helper tool for Twitch Checkpoint Bot queue commands. Quickly build and copy queue commands for Destiny 2 activities." />
  <meta name="theme-color" content="#1a1a2e" />
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='0.9em' font-size='90'>ðŸŽ®</text></svg>">
  <title>Twitch Checkpoint Bot Queue Helper</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="description" content="Helper tool for Twitch Checkpoint Bot queue commands. Quickly build and copy queue commands for Destiny 2 activities." />
  <meta name="theme-color" content="#1a1a2e" />
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='0.9em' font-size='90'>ðŸŽ®</text></svg>">
  <title>Twitch Checkpoint Bot Queue Helper</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <div class="container" role="main">
    <h1>Twitch Checkpoint Bot Queue Helper</h1>
    <!-- Top controls: Bungie Name -->
    <div class="top-controls">
      <div class="bungie-name">
        <label for="bungiename">Bungie Name:</label>
        <div class="input-group">
          <input
            type="text"
            id="bungiename"
            placeholder="bungiename#0000"
            value="fossagenie#9155"
            autocomplete="off"
            spellcheck="false"
            aria-label="Bungie Name"
            aria-describedby="validationMessage"
            required
          />
          <div class="validation-message" id="validationMessage" aria-live="polite">
            Please enter a valid Bungie name (3-32 characters + #0000)
          </div>
        </div>
      </div>
    </div>

    <!-- Activity Type Buttons -->
    <div class="section">
      <div class="section-title">Activity Type</div>
      <div id="activityTypeButtons" class="flex-parent"></div>
    </div>

    <!-- Activity Buttons -->
    <div class="section">
      <div class="section-title">Activity</div>
      <div id="activityButtons" class="flex-parent"></div>
    </div>

    <!-- Difficulty Buttons -->
    <div class="section">
      <div class="section-title">Difficulty</div>
      <div class="flex-parent">
        <button id="difficultyNormalbutton" class="difficulty" aria-pressed="true" type="button">Normal</button>
        <button id="difficultyMasterbutton" class="difficulty" aria-pressed="false" type="button">Master</button>
      </div>
    </div>

    <!-- Encounter Buttons -->
    <div class="section">
      <div class="section-title">Encounter</div>
      <div id="encounterButtons" class="flex-parent"></div>
      <div id="botIndicator" class="bot-indicator"></div>
    </div>

    <!-- Queue Command Output -->
    <div class="queue-section">
      <div id="queueString" class="queue-output" tabindex="0" aria-live="polite">!queue</div>
      <br />
      <button id="copyButton" class="copy-btn" type="button" disabled>Copy to Clipboard</button>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="toast" role="status" aria-live="polite"></div>
  </div>

  <script src="script.js"></script>
</body>
</html>
      'Shattered Throne': ['Boss'],
      'Grasp of Avarice': ['Boss'],
    }
  },
  { bot: 'D2Chests Bot',
    data: {
      'Vault of Glass': ['Confluxes', 'Post-Templar', 'Gatekeeper'],
      'Spire of the Watcher': ['ðŸ—ï¸ Chest1', 'ðŸ—ï¸ Chest2'],
      'Ghosts of the Deep': ['ðŸ—ï¸ Chest1', 'Boss'],
      'Prophecy': ['Chests'],
      'Last Wish': ['Shuro-Chi', 'Morgeth'],
      'Garden of Salvation': ['ðŸ—ï¸ Chest1', 'Sanctified'],
      'Vow of the Disciple': ['ðŸ—ï¸ Chest1', 'ðŸ—ï¸ Chest2'],
      'Root of Nightmares': ['ðŸ—ï¸ Chest1', 'ðŸ—ï¸ Chest2'],
      'Duality': ['ðŸ—ï¸ Chest1', 'ðŸ—ï¸ Chest2'],
      'Deep Stone Crypt': ['ðŸ—ï¸ Chest2'],
    }
  },
  { bot: 'DestinyCheckpoints Bot',
    data: {
      'Duality': ['ðŸ—ï¸ Chest1', 'ðŸ—ï¸ Chest2', 'Boss', '1(M)', '2(M)', 'Boss(M)'],
      'Root of Nightmares': ['ðŸ—ï¸ Chest1', 'ðŸ—ï¸ Chest2', 'Nezarec', 'Nezarec(M)'],
      'Prophecy': ['1', 'ðŸ—ï¸ Chest1', 'Boss'],
      'Spire of the Watcher': ['1', 'Boss'],
      'Ghosts of the Deep': ['ðŸ—ï¸ Chest1', '2', 'Boss'],
      'Vault of Glass': ['Confluxes', 'Post-Templar', 'Atheon'],
      'Deep Stone Crypt': ['Atraks-1', 'ðŸ—ï¸ Chest2', 'Taniks'],
      'Garden of Salvation': ['ðŸ—ï¸ Chest1', 'Sanctified'],
      'Vow of the Disciple': ['ðŸ—ï¸ Chest1', 'ðŸ—ï¸ Chest2'],
      'Last Wish': ['Shuro-Chi', 'Morgeth'],
      'Grasp of Avarice': ['Boss'],
      'Pit of Heresy': ['Boss'],
      'Shattered Throne': ['Boss'],
    }
  },
];

// Returns array of bot names that support the given activity/encounter
function getBotSupport(activityName, encounterName) {
  if (!activityName || !encounterName) return [];
  // Try to match with/without (M) and with/without emoji
  const norm = s => s.replace(/ðŸ—ï¸/g, '').replace(/\(M\)/g, '').replace(/[^\w]/g, '').toLowerCase();
  const isMaster = /\(M\)/.test(encounterName);
  return botSupportMatrix.filter(bot => {
    const encs = bot.data[activityName];
    if (!encs) return false;
    return encs.some(e => {
      // Allow loose match: ignore emoji, punctuation, and (M)
      if (norm(e) === norm(encounterName)) return true;
      // If encounterName is master, allow e.g. "1(M)" to match "1"
      if (isMaster && norm(e) === norm(encounterName.replace(/\(M\)/, ''))) return true;
      return false;
    });
  }).map(bot => bot.bot);
}
    },

    select(encounterIdx) {
      if (state.selectedEncounter === encounterIdx) return;

      state.selectedEncounter = encounterIdx;
      ui.highlightButton(elements.encounterContainer, utils.generateId("encounter", encounterIdx.toString()));
      ui.updateQueueOutput();
      // Automatically copy queue command to clipboard and show notification
      if (state.isComplete()) {
        queueManager.copyToClipboard();
      }
    },

    clear() {
      elements.encounterContainer.innerHTML = "";
    }
  };

  // Difficulty management
  const difficultyManager = {
    init() {
      elements.difficultyNormalBtn.onclick = () => this.select(false);
      elements.difficultyMasterBtn.onclick = () => this.select(true);
      this.select(false); // Default to normal
    },

    select(masterSelected) {
      state.isMasterDifficulty = masterSelected;
      this.updateUI();
      ui.updateQueueOutput();
    },

    update() {
      this.updateUI();
    },

    updateUI() {
      const { difficultyNormalBtn, difficultyMasterBtn } = elements;
      
      difficultyNormalBtn.classList.toggle("highlighted", !state.isMasterDifficulty);
      difficultyMasterBtn.classList.toggle("highlighted", state.isMasterDifficulty);
      // Update ARIA pressed for accessibility
      difficultyNormalBtn.setAttribute('aria-pressed', (!state.isMasterDifficulty).toString());
      difficultyMasterBtn.setAttribute('aria-pressed', (state.isMasterDifficulty).toString());

      if (state.selectedActivityType && state.selectedActivity) {
        const difficultyAllowed = activityData[state.selectedActivityType].activities[state.selectedActivity].difficultyEnabled;
        difficultyMasterBtn.disabled = !difficultyAllowed;
        
        if (!difficultyAllowed && state.isMasterDifficulty) {
          state.isMasterDifficulty = false;
          difficultyNormalBtn.classList.add("highlighted");
          difficultyMasterBtn.classList.remove("highlighted");
        }
      } else {
        difficultyMasterBtn.disabled = true;
      }
    }
  };

  // Input validation
  const inputManager = {
    init() {
      const debouncedValidate = utils.debounce(() => {
        this.validate();
      }, 300);

      elements.bungieNameInput.addEventListener('input', debouncedValidate);
      elements.bungieNameInput.addEventListener('blur', () => this.validate());
      
      // Initial validation
      this.validate();
    },

    validate() {
      const name = elements.bungieNameInput.value.trim();
      state.isValid = utils.validateBungieName(name);
      
      ui.updateValidation(state.isValid);
      ui.updateQueueOutput();
    }
  };

  // Event handlers
  const eventHandlers = {
    init() {
      elements.copyButton.addEventListener('click', () => {
        queueManager.copyToClipboard();
      });

      // Keyboard shortcuts
      document.addEventListener('keydown', (e) => {
        if (e.ctrlKey && e.key === 'c' && state.isComplete()) {
          e.preventDefault();
          queueManager.copyToClipboard();
        }
      });
    }
  };

  // Application initialization
  function init() {
    try {
      activityTypeManager.init();
      difficultyManager.init();
      inputManager.init();
      eventHandlers.init();
      
      console.log('Twitch Checkpoint Bot Queue Helper initialized successfully');
    } catch (error) {
      console.error('Failed to initialize application:', error);
    }
  }

  // Start the application
  document.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>
